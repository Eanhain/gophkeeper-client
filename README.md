# GophKeeper — Клиент (TUI)

Терминальный клиент для менеджера секретов GophKeeper.  
Предоставляет TUI-интерфейс (Bubble Tea) для управления паролями, заметками, файлами и банковскими картами.

## Возможности

- Регистрация и авторизация (JWT)
- CRUD для 4 типов секретов (логины/пароли, текст, бинарные данные, карты)
- Получение конкретного типа секретов от сервера (не только все сразу)
- Локальный зашифрованный кеш в SQLite (AES-256-GCM)
- **Офлайн-режим** — работа при потере соединения с сервером (чтение из кеша)
- Автоматические ретраи с экспоненциальным backoff при сетевых ошибках
- Настройка через `.env` и CLI-флаги

## Архитектура

```
cmd/main.go              — точка входа
configs/                 — загрузка конфигурации (.env + CLI флаги)
contracts/
  request/               — DTO запросов к серверу
  response/              — DTO ответов от сервера
internal/
  usecase/               — бизнес-логика (координация клиента и кеша)
  clientConn/            — HTTP-клиент (Fiber) с ретраями
  crypto/                — AES-256-GCM шифрование/дешифрование (для кеша)
  storage/               — зашифрованный SQLite-кеш
  tui/                   — терминальный интерфейс (Bubble Tea)
  entity/                — доменные модели
```

## Требования

- Go 1.25+
- Запущенный сервер GophKeeper (см. `../gophkeeper/README.md`)

## Быстрый старт

### 1. Убедиться, что сервер запущен

```bash
cd ../gophkeeper
go run ./cmd/app
```

### 2. Настроить .env

Файл `.env` уже в корне проекта. При необходимости поменять:

```env
APP_NAME=gophkeeper-client
APP_VERSION=1.0.0
HTTP_PORT=8080
HTTP_HOST=127.0.0.1
LOG_LEVEL=debug
CRYPTO_KEY=my-local-cache-key
```

`CRYPTO_KEY` — ключ для шифрования локального SQLite-кеша. Не связан с серверным ключом; данные на сервере шифруются отдельным ключом, который выводится из пароля пользователя.

### 3. Запустить клиент

```bash
go run ./cmd/main.go
```

## CLI-флаги

Флаги переопределяют значения из `.env`:

```bash
go run ./cmd/main.go --host 192.168.1.100 --port 9090 --crypto-key my-local-key --log info
```

| Флаг           | Описание                         | По умолчанию  |
|----------------|----------------------------------|---------------|
| `--host`       | Адрес сервера                    | `127.0.0.1`   |
| `--port`       | Порт сервера                     | `8080`        |
| `--crypto-key` | Ключ шифрования локального кеша  | `change-me`   |
| `--log`        | Уровень логирования              | `debug`       |
| `-v`           | Показать версию и выйти          | —             |
| `-h`           | Показать справку                  | —             |

## Управление в TUI

### Экран авторизации

| Клавиша     | Действие                        |
|-------------|---------------------------------|
| `Tab`       | Переключение между полями       |
| `Enter`     | Отправить форму                 |
| `Ctrl+R`    | Переключить режим Login/Register|
| `Ctrl+O`    | Войти в офлайн-режим (read-only)|
| `Ctrl+C`    | Выход                           |

### Главное меню

| Клавиша     | Действие                        |
|-------------|---------------------------------|
| `↑` / `↓`  | Навигация по пунктам            |
| `Enter`     | Выбрать пункт                   |
| `q`         | Выход                           |

### Форма создания/удаления секрета

| Клавиша           | Действие                      |
|-------------------|-------------------------------|
| `Tab`/`Shift+Tab` | Переключение между полями     |
| `Enter`           | Отправить                     |
| `Esc`             | Назад в меню                  |

### Просмотр секретов

| Клавиша     | Действие                        |
|-------------|---------------------------------|
| `Esc`       | Назад в меню                    |

## Офлайн-режим

Клиент использует стратегию **server-first с fallback на кеш**:

1. При запросе секретов клиент сначала обращается к серверу.
2. Если сервер доступен — данные возвращаются пользователю и сохраняются в локальный кеш.
3. Если сервер недоступен (сетевая ошибка, таймаут) — данные читаются из локального кеша.
4. Если кеш пуст и сервер недоступен — возвращается ошибка.

**Вход в офлайн-режим без логина:**
На экране авторизации нажмите `Ctrl+O`. Если в локальном кеше есть данные от предыдущей сессии, откроется главное меню в **read-only режиме** — доступен только просмотр секретов и сброс кеша. Пункты добавления и удаления скрыты, так как для записи нужен сервер.

Операции записи и удаления **требуют подключения к серверу** — при ошибке сети запрос ретраится автоматически.

## Ретраи

HTTP-запросы к серверу автоматически повторяются при сетевых ошибках:

- Максимум **3 попытки**
- Экспоненциальный backoff: 500ms → 1s → 2s (с ограничением до 5s)
- Таймаут на каждый запрос: 10 секунд
- Ретраятся только сетевые ошибки (таймауты, connection refused и т.д.)

## Как работает кеш

- Кеш хранится в SQLite-базе `.gophkeeper_cache.db` в текущей директории.
- Данные сериализуются в JSON, шифруются AES-256-GCM (ключ из `CRYPTO_KEY`) и сохраняются как BLOB.
- При запуске (`Load()`) кеш автоматически загружается с диска в память.
- Любая операция записи/удаления **сбрасывает кеш** — следующий запрос снова пойдёт на сервер.
- Кнопка **"Reset Cache"** в меню принудительно очищает кеш.
- При завершении программы SQLite-соединение корректно закрывается (`Close()`).

## Шифрование

Клиент **не шифрует** HTTP-трафик — данные передаются как обычный JSON. Транспортная безопасность обеспечивается TLS.

Шифрование данных на сервере выполняется per-user ключом (Argon2id + AES-256-GCM) — это зона ответственности сервера.

Локальный кеш шифруется AES-256-GCM с ключом из `CRYPTO_KEY`.

## Тесты

```bash
go test ./...
```

Покрытие:
- `internal/usecase` — бизнес-логика, офлайн-режим, server-first стратегия
- `internal/crypto` — AES-256-GCM шифрование/дешифрование
- `internal/storage` — SQLite-кеш, persistence, шифрование
